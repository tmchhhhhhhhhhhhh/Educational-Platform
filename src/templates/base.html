{% load django_htmx %}

<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% load static %}
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js" 
      integrity="sha384-ZBXiYtYQ6hJ2Y0ZNoYuI+Nq5MqWBr+chMrS/RkXpNzQCApHEhOt2aY8EJgqwHLkJ" 
      crossorigin="anonymous"></script>

    <title>{% block head_title %}{% endblock head_title %}</title>
  </head>
  <body hx-header='{"X_CSRFToken": "{{csrf_token}}"}'>

    <div id="hx-login" hx-get="/hx/login/" hx-trigger="load" hx-target="#hx-login" hx-swap="outerHTML"></div>

    {% block content %}
    <br>
    {% endblock content %}

    <h1 class="text-3xl font-bold underline"></h1>

<script>
function startSessionTimer() {
    let sessionTimeout = {{ request.session.get_expiry_age|default:600 }} * 1000; // –≤ –º—Å
    let warningTime = 60 * 1000; // –∑–∞ –º–∏–Ω—É—Ç—É –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º

    // –¢–∞–π–º–µ—Ä –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    setTimeout(() => {
        const modal = document.createElement('div');
        modal.id = "session-modal";
        modal.innerHTML = `
            <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:#0008;display:flex;align-items:center;justify-content:center;z-index:9999">
                <div style="background:white;padding:20px;border-radius:8px;text-align:center;">
                    <h3>–°–µ—Å—Å–∏—è —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç</h3>
                    <p>–ü—Ä–æ–¥–ª–∏—Ç—å —Å–µ—Å—Å–∏—é?</p>
                    <button id="extend-session">–ü—Ä–æ–¥–ª–∏—Ç—å</button>
                    <button id="logout-session">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        document.getElementById('extend-session').onclick = () => {
            fetch('/hx/extend-session/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === "ok") {
                    console.log("üîÅ –°–µ—Å—Å–∏—è –ø—Ä–æ–¥–ª–µ–Ω–∞");
                    document.getElementById('session-modal').remove();
                    startSessionTimer(); // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                } else {
                    alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞!");
                    window.location.href = '/';
                }
            });
        };

        document.getElementById('logout-session').onclick = () => {
            fetch('/hx/logout/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                .then(() => window.location.href = '/');
        };

    }, sessionTimeout - warningTime);
}

// –ó–∞–ø—É—Å–∫
document.addEventListener('DOMContentLoaded', startSessionTimer);
</script>

  </body>
</html>
